<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RMF Remote Control</title>
    <style type="text/css" media="screen">
    body {
      margin:0;
      padding:0;
      background-color: black;
    }

    .joystick {
      margin: auto;
      display: block;
      width: 200px;
      height: 100px;
      margin-top: 30px;

      transform: rotate(270deg) translateX(-100px);
    }

    #joystick1 {
      transform: rotate(270deg) translateX(-100px) translateY(-100px);
    }

    #joystick2 {
      transform: rotate(270deg) translateX(30px) translateY(100px);
    }
    </style>
  </head>
  <body id="body" onload="onBodyLoad()">
    <input type="range" min="-1024" max="1024" value="0" step="1" class="joystick" id="joystick1">
    <input type="range" min="-1024" max="1024" value="0" step="1" class="joystick" id="joystick2">

    <script>
        var ws = null;

        function addMessage(message) {
          console.log(message);
        }

        function sendSpeed(motorNumber, speed){
          var buf = new Int32Array(2);
          buf[0] = motorNumber;
          buf[1] = speed;
          ws.send(buf);
        }
        
        function startSocket(){
          ws = new WebSocket('ws://'+document.location.host+'/ws',['arduino']);
          ws.binaryType = "arraybuffer";
          ws.onopen = function(e){
            addMessage("Connected");
          };
          ws.onclose = function(e){
            addMessage("Disconnected");
          };
          ws.onerror = function(e){
            console.log("ws error", e);
            addMessage("Error");
          };
          ws.onmessage = function(e){
            var msg = "";
            if(e.data instanceof ArrayBuffer){
              msg = "BIN:";
              var bytes = new Uint8Array(e.data);
              for (var i = 0; i < bytes.length; i++) {
                msg += String.fromCharCode(bytes[i]);
              }
            } else {
              msg = "TXT:"+e.data;
            }
            addMessage(msg);
          };
        }

        startSocket();

        function initJoystick(speedElement, motorNumber) {
          speedElement.addEventListener('input', value => {
            sendSpeed(motorNumber, speedElement.value);
          });

          speedElement.addEventListener('mouseup', () => setTimeout(() => { 
            speedElement.value = 0
            ; sendSpeed(motorNumber, 0);
          }, 0));
          
          speedElement.addEventListener('touchend', () => setTimeout(() => { 
            speedElement.value = 0
            ; sendSpeed(motorNumber, 0);
          }, 0));
        }

        initJoystick(document.getElementById('joystick1'), 1);
        initJoystick(document.getElementById('joystick2'), 2);
    </script>
  </body>
</html>
